function getState(e,t){"use strict";return t>=e.numRows()?0:e.getValue(t,STATE_COLUMN)}function toDygraphArray(jsonData){"use strict";var i,j,cols=jsonData.cols,rows=jsonData.rows,dataArray=[],labelsArray=[],annotationsArray=[],row,date,handlers=[],numberHandler=function(e,t){if(t){row.push(t.v)}else{row.push(null)}},datetimeHandler=function(index,val){date=eval("new "+val.v);row.push(date)},annotationHandler=function(e,t){if(!t){return}var n={};annotationsArray.push({series:labelsArray[e*2/3],x:date.getTime(),shortText:String.fromCharCode(65+annotationsArray.length%26),text:t.v,attachAtBottom:true})};for(i=0;i<cols.length;i++){if(cols[i].type==="number"){handlers.push(numberHandler);labelsArray.push(cols[i].label)}else if(cols[i].type==="datetime"){handlers.push(datetimeHandler);labelsArray.push(cols[i].label)}else if(cols[i].type==="string"){handlers.push(annotationHandler)}}for(i=0;i<rows.length;i++){row=[];for(j=0;j<rows[i].c.length;j++){handlers[j](j,rows[i].c[j])}dataArray.push(row)}return{values:dataArray,labels:labelsArray,annotations:annotationsArray}}function getTime(e,t){"use strict";if(t>=e.numRows()){t=e.numRows()-1}return e.getValue(t,TIME_COLUMN)}function findStateBlocks(e,t,n){"use strict";var r=[];var i=getState(e,t);var s;for(var o=t;o<n;o++){s=getState(e,o);if(s!==i){r.push({row:o,state:i});i=s}}r.push({row:n,state:i});return r}function findDataRow(e,t){"use strict";var n=0,r=e.numRows()-1;var i,s;while(n<r){i=Math.floor((n+r)/2);s=e.getValue(i,0)-t;if(s<0){n=i+1;continue}if(s>0){r=i-1;continue}return i}return n}function paintBackground(e,t,n){"use strict";currentDataSet=n;e.save();try{paintBackgroundImpl(e,t,n)}finally{e.restore()}}function paintBackgroundImpl(e,t,n){"use strict";var r=[n.toDataXCoord(t.x),n.toDataXCoord(t.x+t.w)];var i=r[0];var s=r[1];var o=Math.max(findDataRow(n,i)-1,0);var u=findDataRow(n,s)+1;if(o===null||u===null){return}var a=findStateBlocks(n,o,u);var f=0;for(var l=0;l<a.length;l++){var c=a[l];var h=c.row;var p=getTime(n,h);var d=(p-i)/(s-i);var v=Math.floor(t.x+t.w*d);var m=STATES[parseInt(c.state,10)];if(m===undefined){m=STATES[0]}e.fillStyle=m.color;e.fillRect(f,t.h-STATE_LINE_WIDTH,v-f,t.h);f=v}}function formatForChartLegend(e){"use strict";var t=parseFloat(e);if(!isNaN(t)){return t.toFixed(2)+"°"+window.tempFormat}return"--"}function showChartLegend(e,t,n,r,i){"use strict";var s=profileTable.formatDate(new Date(t)).display;$("#curr-beer-chart-legend .beer-chart-legend-time").text(s);$("#curr-beer-chart-legend .beer-chart-legend-row.beerTemp .beer-chart-legend-value").text(formatForChartLegend(currentDataSet.getValue(r,1)));$("#curr-beer-chart-legend .beer-chart-legend-row.beerSet .beer-chart-legend-value").text(formatForChartLegend(currentDataSet.getValue(r,2)));$("#curr-beer-chart-legend .beer-chart-legend-row.fridgeTemp .beer-chart-legend-value").text(formatForChartLegend(currentDataSet.getValue(r,3)));$("#curr-beer-chart-legend .beer-chart-legend-row.fridgeSet .beer-chart-legend-value").text(formatForChartLegend(currentDataSet.getValue(r,4)));$("#curr-beer-chart-legend .beer-chart-legend-row.roomTemp .beer-chart-legend-value").text(formatForChartLegend(currentDataSet.getValue(r,5)));var o=parseInt(currentDataSet.getValue(r,STATE_COLUMN));if(!isNaN(o)){$("#curr-beer-chart-legend .beer-chart-legend-row.state .beer-chart-legend-label").text(STATES[o].text);$("#curr-beer-chart-legend .beer-chart-legend-row.state .state-indicator").css("background-color",STATES[o].color)}}function hideChartLegend(){"use strict";$("#curr-beer-chart-legend .beer-chart-legend-row").each(function(){$(this).find(".beer-chart-legend-value").text("--")});$("#curr-beer-chart-legend .beer-chart-legend-time").text("Date/Time");$("#curr-beer-chart-legend .beer-chart-legend-row.state .beer-chart-legend-label").text("State");$("#curr-beer-chart-legend .beer-chart-legend-row.state .state-indicator").css("background-color","")}function findLineByName(e){"use strict";for(var t in lineNames){if(lineNames.hasOwnProperty(t)){if(lineNames[t]===e){return t}}}return null}function drawBeerChart(e,t){"use strict";var n=$("#"+t);n.empty();if(e==="None"){var r=$("<span class='chart-error-text'>"+"BrewPi is currently not logging data. Start a new brew to resume logging.<br>"+"You can find your previous beers under Maintenance Panel -> Previous Beers</span>");n.addClass("chart-error");n.append(r);return}$.post("get_beer_data.php",{beername:e},function(r){var i={};try{i=$.parseJSON(r)}catch(s){var o=$("<span class='chart-error-text'>Could not parse data for this brew.<br>"+"If you just started this brew, click the refresh button after a few minutes.<br> "+"A chart will appear after the first data point is logged.</span>");var u=$("<button class='chart-error-refresh'>Refresh</button>");u.button({icons:{primary:"ui-icon-refresh"}}).click(function(){drawBeerChart(e,t)});n.addClass("chart-error");n.append(o);n.append(u);return}var a=toDygraphArray(i);var f=function(e){return parseFloat(e).toFixed(2)+"° "+window.tempFormat};var l=new Dygraph(document.getElementById(t),a.values,{labels:a.labels,colors:chartColors,axisLabelFontSize:12,animatedZooms:true,gridLineColor:"#ccc",gridLineWidth:"0.1px",labelsDiv:document.getElementById(t+"-label"),displayAnnotations:true,displayAnnotationsFilter:true,strokeWidth:1,axes:{y:{valueFormatter:f}},highlightCircleSize:2,highlightSeriesOpts:{strokeWidth:1.5,strokeBorderWidth:1,highlightCircleSize:5},highlightCallback:function(e,t,n,r){showChartLegend(e,t,n,r,l)},unhighlightCallback:function(e){hideChartLegend()},underlayCallback:paintBackground,drawCallback:function(e,t){if(t){if(a.annotations.length>0){e.setAnnotations(a.annotations)}}}});l.setVisibility(l.indexFromSetName("State")-1,0);var c=n.parent();c.find(".beer-chart-controls").show();if(t.localeCompare("curr-beer-chart")===0){currBeerChart=l}else if(t.localeCompare("prev-beer-chart")===0){prevBeerChart=l}for(var h in lineNames){if(lineNames.hasOwnProperty(h)){var p=c.find(".beer-chart-legend-row."+h);var d=l.getPropertiesForSeries(lineNames[h]);if(d===null){p.hide()}else{var v=l.numRows();if(isDataEmpty(l,d.column,0,v-1)){p.hide()}if(localStorage.getItem(legendStorageKeyPrefix+h)==="false"){p.find(".toggle").addClass("inactive")}updateVisibility(h,p.find(".toggle"))}if($(t+" .toggleAnnotations ").hasClass("inactive")){$(l).find(".dygraphDefaultAnnotation").css("visibility","hidden")}}}var m=0;$("#curr-beer-chart-legend .beer-chart-legend-row").each(function(){if(!$(this).hasClass("time")&&!$(this).is(":hidden")){$(this).addClass(m%2===1?"alt":"");m++}})})}function isDataEmpty(e,t,n,r){"use strict";for(var i=r;i>n;i--){if(e.getValue(i,t)!==null){return false}}return true}function toggleLine(e){"use strict";var t=$(e);if(t.hasClass("beer-chart-legend-label")){t=t.prev()}t.toggleClass("inactive");var n=t.attr("class");var r=n.split(/\s+/);for(var i in r){if(r.hasOwnProperty(i)){if(r[i]in lineNames){break}}}updateVisibility(r[i],t)}function updateVisibility(e,t){"use strict";var n=t.closest(".chart-container").find(".beer-chart");var r=n.attr("id");var i;if(r.localeCompare("curr-beer-chart")===0){i=currBeerChart}else if(r.localeCompare("prev-beer-chart")===0){i=prevBeerChart}else{console.log("cannot find chart with id "+r);return}if(t.hasClass("inactive")){i.setVisibility(i.getPropertiesForSeries(lineNames[e]).column-1,false);localStorage.setItem(legendStorageKeyPrefix+e,"false")}else{i.setVisibility(i.getPropertiesForSeries(lineNames[e]).column-1,true);localStorage.setItem(legendStorageKeyPrefix+e,"true")}}function applyStateColors(){"use strict";$(".state-color.state-cooling").css("background-color",colorCool);$(".state-color.state-heating").css("background-color",colorHeat);$(".state-color.state-waiting-to-cool").css("background-color",colorWaitingCool);$(".state-color.state-waiting-to-heat").css("background-color",colorWaitingHeat);$(".state-color.state-heating-min-time").css("background-color",colorHeatingMinTime);$(".state-color.state-cooling-min-time").css("background-color",colorCoolingMinTime);$(".state-color.state-waiting-peak").css("background-color",colorWaitingPeakDetect);$(".state-color.state-idle").css("background-color",colorIdle)}function toggleAnnotations(e){"use strict";var t=$(e);if(t.hasClass("beer-chart-legend-label")){t=t.prev()}t.toggleClass("inactive");var n=t.closest(".chart-container").find(".beer-chart");var r=n.attr("id");if($(t).hasClass("inactive")){n.find(".dygraphDefaultAnnotation").css("visibility","hidden")}else{n.find(".dygraphDefaultAnnotation").css("visibility","visible")}}var currBeerChart;var prevBeerChart;var colorIdle="white";var colorCool="rgba(0, 0, 255, 0.4)";var colorHeat="rgba(255, 0, 0, 0.4)";var colorWaitingHeat="rgba(255, 0, 0, 0.2)";var colorWaitingCool="rgba(0, 0, 255, 0.2)";var colorHeatingMinTime="rgba(255, 0, 0, 0.6)";var colorCoolingMinTime="rgba(0, 0, 255, 0.6)";var colorWaitingPeakDetect="rgba(0, 0, 0, 0.2)";var lineNames={beerTemp:"Beer temperature",beerSet:"Beer setting",fridgeTemp:"Fridge temperature",fridgeSet:"Fridge setting",roomTemp:"Room temp."};var legendStorageKeyPrefix="legendLine_";var TIME_COLUMN=0;var STATE_COLUMN=6;var STATE_LINE_WIDTH=15;var STATES=[{name:"IDLE",color:colorIdle,text:"Idle"},{name:"STATE_OFF",color:colorIdle,text:"Off"},{name:"DOOR_OPEN",color:"#eee",text:"Door Open",doorOpen:true},{name:"HEATING",color:colorHeat,text:"Heating"},{name:"COOLING",color:colorCool,text:"Cooling"},{name:"WAITING_TO_COOL",color:colorWaitingCool,text:"Waiting to Cool",waiting:true},{name:"WAITING_TO_HEAT",color:colorWaitingHeat,text:"Waiting to Heat",waiting:true},{name:"WAITING_FOR_PEAK_DETECT",color:colorWaitingPeakDetect,text:"Waiting for Peak",waiting:true},{name:"COOLING_MIN_TIME",color:colorCoolingMinTime,text:"Cooling Min Time",extending:true},{name:"HEATING_MIN_TIME",color:colorHeatingMinTime,text:"Heating Min Time",extending:true}];CanvasRenderingContext2D.prototype.dashedLine=function(e,t,n,r,i){"use strict";if(i===undefined){i=2}this.beginPath();this.moveTo(e,t);var s=n-e;var o=r-t;var u=Math.floor(Math.sqrt(s*s+o*o)/i);var a=s/u;var f=o/u;var l=0;while(l++<u){e+=a;t+=f;this[l%2===0?"moveTo":"lineTo"](e,t)}this[l%2===0?"moveTo":"lineTo"](n,r);this.stroke();this.closePath()};var currentDataSet=null;var chartColors=["rgb(41,170,41)","rgb(240, 100, 100)","rgb(89, 184, 255)","rgb(255, 161, 76)","#AAAAAA","rgb(153,0,153)"];$(document).ready(function(){"use strict";$("button.refresh-curr-beer-chart").button({icons:{primary:"ui-icon-refresh"},text:false}).click(function(){drawBeerChart(window.beerName,"curr-beer-chart")});$("#chart-help-popup").dialog({autoOpen:false,height:600,width:960});$("button.chart-help").button({icons:{primary:"ui-icon-help"},text:false}).click(function(){$("#chart-help-popup").dialog("open")});applyStateColors()})