function statusMessage(e,t){"use strict";var n=$("#status-message");var r=n.find("p span#icon");n.removeClass("ui-state-error ui-state-default ui-state-highlight");r.removeClass("ui-icon-error ui-icon-check ui-icon-info");switch(e){case"normal":r.addClass("ui-icon-check");n.addClass("ui-state-default");break;case"error":r.addClass("ui-icon-error");n.addClass("ui-state-error");break;case"highlight":r.addClass("ui-icon-info");n.addClass("ui-state-highlight");break}n.find("p span#message").text(t)}function loadControlPanel(){"use strict";if(window.profileName!==""){loadProfile(window.profileName,renderProfile)}receiveControlSettings(function(){if(window.controlSettings==={}){return}var e=$("#control-panel");switch(window.controlSettings.mode){case"p":e.tabs("option","active",0);statusMessage("normal","Running beer profile: "+decodeURIComponent(window.controlSettings.profile));break;case"b":e.tabs("option","active",1);statusMessage("normal","Running in beer constant mode");break;case"f":e.tabs("option","active",2);statusMessage("normal","Running in fridge constant mode");break;case"o":e.tabs("option","active",3);statusMessage("normal","Temperature control disabled");break;default:statusMessage("error","Invalid mode ("+window.controlSettings.mode+") received")}window.beerTemp=parseFloat(window.controlSettings.beerSet);window.fridgeTemp=parseFloat(window.controlSettings.fridgeSet);if(isNaN(window.beerTemp)){window.beerTemp=defaultTemp()}if(isNaN(window.fridgeTemp)){window.fridgeTemp=defaultTemp()}$("#beer-temp").find("input.temperature").val(window.beerTemp.toFixed(1));$("#fridge-temp").find("input.temperature").val(window.fridgeTemp.toFixed(1))})}function defaultTemp(){"use strict";if(typeof window.tempFormat==="F"){return 68}else{return 20}}function tempUp(e){"use strict";if(isNaN(e)){return defaultTemp()}e+=.1;if(e>window.controlConstants.tempSetMax){e=window.controlConstants.tempSetMin}return e}function tempDown(e){"use strict";if(isNaN(e)){return defaultTemp()}e-=.1;if(e<window.controlConstants.tempSetMin){e=window.controlConstants.tempSetMax}return e}function applySettings(){"use strict";var e=$("#control-panel").tabs("option","active");switch(e){case 0:$.post("socketmessage.php",{messageType:"setActiveProfile",message:window.profileName},function(e){if(e!==""){statusMessage("highlight",e)}});break;case 1:var t=$("#beer-temp").find("input.temperature");$.post("socketmessage.php",{messageType:"setBeer",message:t.val()},function(){});statusMessage("highlight","Mode set to beer constant");break;case 2:var n=$("#fridge-temp").find("input.temperature");$.post("socketmessage.php",{messageType:"setFridge",message:n.val()},function(){});statusMessage("highlight","Mode set to fridge constant");break;case 3:$.post("socketmessage.php",{messageType:"setOff",message:""},function(){});statusMessage("highlight","Temperature control disabled");break}setTimeout(loadControlPanel,5e3)}function renderProfile(e){"use strict";window.profileName=e.name;profileTable.render(e);$("#profileTableName").text(decodeURIComponent(window.profileName));$("button#edit-controls").show();$("button#saveas-controls").show();drawProfileChart("profileChartDiv",profileTable)}function drawSelectPreviewChart(e){"use strict";$("#profileSelectChartDiv").html("<span class='chart-loading chart-placeholder'>Loading profile...</span>");loadProfile(e,function(e){profileSelect.render(e);drawProfileChart("profileSelectChartDiv",profileSelect)});$("#profileSelectChartDiv span.chart-loading").text("Error Loading profile!")}function drawEditPreviewChart(){"use strict";$("#profileEditChartDiv").html("<span class='chart-loading chart-placeholder'>Redrawing profile...</span>");drawProfileChart("profileEditChartDiv",profileEdit);$("#profileEditChartDiv span.chart-loading").text("Error drawing profile chart!")}function drawProfileChart(e,t){"use strict";var n=function(e){return parseFloat(e).toFixed(2)+"Â° "+window.tempFormat};var r=function(e){return profileTable.formatDate(e).display};var i=function(e){if(e>20){return Dygraph.EVERY4DAYS}else if(e>13){return Dygraph.EVERY3DAYS}else if(e>7){return Dygraph.EVERY2DAYS}else{return Dygraph.DAILY}};var s=function(e,t,n){if(n.numRows()<1){return}e.fillStyle="rgba(255, 100, 100, 1.0)";var r=(new Date).getTime();var i=n.getValue(0,0);var s=n.getValue(n.numRows()-1,0);if(r<i){e.textAlign="start";e.font="14px Arial";e.fillText("<< Current time",t.x+10,t.h-10)}else if(r>s){e.textAlign="end";e.font="14px Arial";e.fillText("Current time >>",t.x+t.w-10,t.h-10)}else{var o=n.toDomXCoord(r);e.fillRect(o,t.y+17,1,t.h-17);for(var u=0;u<n.numRows();u++){if(n.getValue(u,0)>r){break}}var a=parseFloat(n.getValue(u-1,1));var f=parseFloat(n.getValue(u,1));var l=n.getValue(u-1,0);var c=n.getValue(u,0);var h=(a+(f-a)*(r-l)/(c-l)).toFixed(2);var p=n.toDomYCoord(h);e.font="20px Arial";if(o<.5*t.w){e.textAlign="start";if(f>=parseFloat(h)){p+=20}e.fillText(h,o+5,p)}else{if(a>=parseFloat(h)){p+=20}e.textAlign="end";e.fillText(h,o-5,p)}}};var o={colors:["rgb(89, 184, 255)"],axisLabelFontSize:12,gridLineColor:"#ccc",gridLineWidth:"0.1px",labelsDiv:document.getElementById(e+"-label"),legend:"always",labelsDivStyles:{textAlign:"right"},strokeWidth:1,xValueParser:function(e){return profileTable.parseDate(e)},underlayCallback:s,Temperature:{},axes:{y:{valueFormatter:n},x:{valueFormatter:r}},highlightCircleSize:2,highlightSeriesOpts:{strokeWidth:1.5,strokeBorderWidth:1,highlightCircleSize:5},yAxisLabelWidth:35};var u=t.getProfileDuration();if(u<28&&u>0){o.axes.x.ticker=function(e,t,n,r,s,o){return Dygraph.getDateAxis(e,t,i(u),r,s)}}var a=new Dygraph(document.getElementById(e),t.toCSV(true,["date","temperature"]),o)}function loadProfile(e,t){"use strict";$.post("get_beer_profile.php",{name:e},function(e){try{if(typeof t!=="undefined"){t(e)}}catch(n){console.log("Error loading profile: "+n.toString())}},"json")}function showProfileSelectDialog(){"use strict";var e;$("#profileSelect").selectable({stop:function(t,n){$(".ui-selected:first",this).each(function(){$(this).siblings().removeClass("ui-selected");e=$(this).data("profileName");drawSelectPreviewChart(e)})}});$.post("get_beer_profiles.php",{},function(e){try{$("#profileSelect").empty();for(var t=0;t<e.profiles.length;t++){var n=$("<li></li>").addClass("ui-widget-content").data("profileName",e.profiles[t]).text(decodeURIComponent(e.profiles[t]));$("#profileSelect").append(n)}}catch(r){console.log("Can not load temperature profiles")}},"json");$("#profileSelectDiv").dialog({modal:true,title:"Select Temperature Profile",buttons:[{text:"OK",click:function(){if(typeof e!=="undefined"){loadProfile(e,renderProfile)}$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}],width:960})}function promptToApplyProfile(e){"use strict";$("<div>You are editing the current profile: "+decodeURIComponent(e)+".  Would you like to apply it now?</div>").dialog({modal:true,title:"Apply Profile: "+decodeURIComponent(e)+"?",buttons:[{text:"Apply",click:function(){applySettings();$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}]})}function showProfileEditDialog(e,t,n){"use strict";function i(e,t,n){$.ajax({type:"post",url:"save_beer_profile.php",dataType:"json",data:{name:t,profile:n},success:function(n){if(n.status!=="error"){loadProfile(t,renderProfile);$("#profileSaveError").hide();$("#profileEditName").removeAttr("disabled");e.dialog("close");if(window.controlSettings.mode==="p"&&window.controlSettings.profile===t){promptToApplyProfile(t)}}else{console.log("profile save error: "+decodeURIComponent(n.message));$("#profileSaveError").show()}},error:function(e,t,n){console.log("profile save HTTP error - request status: "+e.status+" - error: "+n);$("#profileSaveError").show()}})}$("#profileSaveError").hide();var r=[];$.post("get_beer_profiles.php",{},function(e){r=e.profiles},"json");$("#profileEditDiv").dialog({modal:true,title:t,open:function(t,r){if(!e){$("#profileEditName").attr("disabled",true)}if(n){$("#profileEditName").focus()}else{$("#profileEditDiv table tr").last().find("td").first().focus()}},buttons:[{text:"Save",click:function(){function t(e){for(var t=0;t<r.length;t++){if(e===r[t]){return true}}return false}if(profileEdit.hasInvalidDayCells()){profileEdit.markInvalidCells();return}else{profileEdit.resetInvalidCells()}var n=encodeURIComponent($("#profileEditName").val());if(typeof n!=="undefined"&&n!==""){$("#profileEditNameLabel").removeClass("error");var s=$(this);if(e&&t(n)){$("<div>Are you sure you want to overwrite the profile: "+decodeURIComponent(n)+"?</div>").dialog({resizable:false,height:140,modal:true,buttons:{Ok:function(){i(s,n,profileEdit.toCSV(true));$(this).dialog("close")},Cancel:function(){$("#profileEditName").focus();$(this).dialog("close")}}})}else{i(s,n,profileEdit.toCSV(true))}}else{$("#profileEditNameLabel").addClass("error");$("#profileEditName").focus()}}},{text:"Cancel",click:function(){$("#profileEditName").removeAttr("disabled");$(this).dialog("close")}}],width:960});drawEditPreviewChart()}function showProfileHelpDialog(){"use strict";$("#profileHelpDiv").dialog({modal:true,title:"Beer Temperature Profile Help",width:960})}function profTableContextMenuHandler(e){"use strict";if(e){$("html").bind("click",profTableGlobalClickHandler)}else{$("html").unbind("click",profTableGlobalClickHandler)}}function profTableGlobalClickHandler(){"use strict";profileEdit.closeContextMenu()}function startFridgeTempUpInterval(){"use strict";clearFridgeTempUpInterval();var e=$("#fridge-temp").find("input.temperature");if(e.find(":focus")){window.fridgeTemp=tempUp(parseFloat(e.val()))}else{window.fridgeTemp=tempUp(window.fridgeTemp)}e.val(window.fridgeTemp.toFixed(1));window.fridgeTempUpTimeOut=window.setInterval(function(){window.fridgeTemp=tempUp(window.fridgeTemp);$("#fridge-temp").find("input.temperature").val(window.fridgeTemp.toFixed(1))},100)}function clearFridgeTempUpInterval(){"use strict";if(typeof window.fridgeTempUpTimeOut!=="undefined"){clearInterval(window.fridgeTempUpTimeOut)}}function startFridgeTempDownInterval(){"use strict";clearFridgeTempDownInterval();var e=$("#fridge-temp").find("input.temperature");if(e.find(":focus")){window.fridgeTemp=tempDown(parseFloat(e.val()))}else{window.fridgeTemp=tempDown(window.fridgeTemp)}e.val(window.fridgeTemp.toFixed(1));window.fridgeTempDownTimeOut=window.setInterval(function(){window.fridgeTemp=tempDown(window.fridgeTemp);$("#fridge-temp").find("input.temperature").val(window.fridgeTemp.toFixed(1))},100)}function clearFridgeTempDownInterval(){"use strict";if(typeof window.fridgeTempDownTimeOut!=="undefined"){clearInterval(window.fridgeTempDownTimeOut)}}function startBeerTempUpInterval(){"use strict";clearBeerTempUpInterval();var e=$("#beer-temp").find("input.temperature");if(e.find(":focus")){window.beerTemp=tempUp(parseFloat(e.val()))}else{window.beerTemp=tempUp(window.beerTemp)}e.val(window.beerTemp.toFixed(1));window.beerTempUpTimeOut=window.setInterval(function(){window.beerTemp=tempUp(window.beerTemp);$("#beer-temp").find("input.temperature").val(window.beerTemp.toFixed(1))},100)}function clearBeerTempUpInterval(){"use strict";if(typeof window.beerTempUpTimeOut!=="undefined"){clearInterval(window.beerTempUpTimeOut)}}function startBeerTempDownInterval(){"use strict";clearBeerTempDownInterval();var e=$("#beer-temp").find("input.temperature");if(e.find(":focus")){window.beerTemp=tempDown(parseFloat(e.val()))}else{window.beerTemp=tempDown(window.beerTemp)}e.val(window.beerTemp.toFixed(1));window.beerTempDownTimeOut=window.setInterval(function(){window.beerTemp=tempDown(window.beerTemp);$("#beer-temp").find("input.temperature").val(window.beerTemp.toFixed(1))},100)}function clearBeerTempDownInterval(){"use strict";if(typeof window.beerTempDownTimeOut!=="undefined"){clearInterval(window.beerTempDownTimeOut)}}var beerTemp=defaultTemp();var fridgeTemp=defaultTemp();var profileTable;var profileEdit;var profileSelect;Dygraph.EVERY2DAYS=-1;Dygraph.EVERY3DAYS=-2;Dygraph.EVERY4DAYS=-3;var _1DAY=1e3*86400;Dygraph.SHORT_SPACINGS[Dygraph.EVERY2DAYS]=2*_1DAY;Dygraph.SHORT_SPACINGS[Dygraph.EVERY3DAYS]=3*_1DAY;Dygraph.SHORT_SPACINGS[Dygraph.EVERY4DAYS]=4*_1DAY;$(document).ready(function(){"use strict";profileEdit=new BeerProfileTable("profileEditControls",{tableClass:"profileTableEdit ui-widget",theadClass:"ui-widget-header",tbodyClass:"ui-widget-content",editable:true,startDateFieldSelector:"#profileEditStartDate",dateFormat:window.dateTimeFormat,dateFormatDisplay:window.dateTimeFormatDisplay,contextMenuCssClass:"profileTableMenu",contextMenuDisplayHandler:profTableContextMenuHandler,chartUpdateCallBack:drawEditPreviewChart});profileTable=new BeerProfileTable("profileTableDiv",{tableClass:"profileTableEdit ui-widget",theadClass:"ui-widget-header",tbodyClass:"ui-widget-content",editable:false,startDateFieldSelector:"#profileTableStartDate",dateFormat:window.dateTimeFormat,dateFormatDisplay:window.dateTimeFormatDisplay});profileSelect=new BeerProfileTable("profileSelectTableDiv",{editable:false,dateFormat:window.dateTimeFormat,dateFormatDisplay:window.dateTimeFormatDisplay});$("button#refresh-controls").button({icons:{primary:"ui-icon-arrowrefresh-1-e"}}).click(function(){if(window.profileName!==""){loadProfile(window.profileName,renderProfile)}});$("button#load-controls").button({icons:{primary:"ui-icon-folder-open"}}).click(function(){showProfileSelectDialog()});$("button#new-controls").button({icons:{primary:"ui-icon-plus"}}).click(function(){$("#profileEditName").val("");$("#profileEditStartDate").val("");profileEdit.render({name:"",profile:[]});showProfileEditDialog(true,"New Temperature Profile")});$("button#edit-controls").button({icons:{primary:"ui-icon-wrench"}}).click(function(){$("#profileEditName").val(decodeURIComponent(profileTable.profileName));profileEdit.render(profileTable.toJSON());showProfileEditDialog(false,"Edit Temperature Profile")}).hide();$("button#saveas-controls").button({icons:{primary:"ui-icon-copy"}}).click(function(){$("#profileEditName").val("copy of "+decodeURIComponent(profileTable.profileName));profileEdit.render(profileTable.toJSON());showProfileEditDialog(true,"Save Temperature Profile As",true)}).hide();$("button#help-profile").button({icons:{primary:"ui-icon-help"}}).click(function(){showProfileHelpDialog()});$("#profileEditStartDate").datetimepicker({dateFormat:window.dateTimeFormatDisplay,timeFormat:"HH:mm:ss",onSelect:function(){profileEdit.updateDisplay()}});$("button#profileEditAddCurrentButton").button().click(function(){profileEdit.insertRowNow()});$("button#profileEditNowButton").button().click(function(){$("#profileEditStartDate").datetimepicker("setDate",new Date);profileEdit.updateDisplay()});$("button#apply-settings").button({icons:{primary:"ui-icon-check"}}).click(function(){applySettings()});$("input.temperature").each(function(){$(this).blur(function(){var e=parseFloat($(this).val());if(e<window.controlConstants.tempSetMin){e=window.controlConstants.tempSetMin;$(this).val(e)}if(e>window.controlConstants.tempSetMax){e=window.controlConstants.tempSetMax;$(this).val(e)}if(isNaN(e)){e=defaultTemp()}$(this).val(e.toFixed(1));if($(this).parent().attr("id").localeCompare("beer-temp")===0){window.beerTemp=parseFloat(e)}if($(this).parent().attr("id").localeCompare("fridge-temp")===0){window.fridgeTemp=parseFloat(e)}});$(this).keyup(function(e){if($(this).parent().attr("id").localeCompare("beer-temp")===0){if(e.which===38){clearBeerTempUpInterval()}else if(e.which===40){clearBeerTempDownInterval()}}if($(this).parent().attr("id").localeCompare("fridge-temp")===0){if(e.which===38){clearFridgeTempUpInterval()}else if(e.which===40){clearFridgeTempDownInterval()}}});$(this).keydown(function(e){if($(this).parent().attr("id").localeCompare("beer-temp")===0){if(e.which===38){startBeerTempUpInterval()}else if(e.which===40){startBeerTempDownInterval()}}if($(this).parent().attr("id").localeCompare("fridge-temp")===0){if(e.which===38){startFridgeTempUpInterval()}else if(e.which===40){startFridgeTempDownInterval()}}})});$("button#beer-temp-up").button({icons:{primary:"ui-icon-triangle-1-n"}}).bind({mousedown:startBeerTempUpInterval,mouseup:clearBeerTempUpInterval,mouseleave:clearBeerTempUpInterval});$("button#beer-temp-down").button({icons:{primary:"ui-icon-triangle-1-s"}}).bind({mousedown:startBeerTempDownInterval,mouseup:clearBeerTempDownInterval,mouseleave:clearBeerTempDownInterval});$("button#fridge-temp-up").button({icons:{primary:"ui-icon-triangle-1-n"}}).bind({mousedown:startFridgeTempUpInterval,mouseup:clearFridgeTempUpInterval,mouseleave:clearFridgeTempUpInterval});$("button#fridge-temp-down").button({icons:{primary:"ui-icon-triangle-1-s"}}).bind({mousedown:startFridgeTempDownInterval,mouseup:clearFridgeTempDownInterval,mouseleave:clearFridgeTempDownInterval});$("#control-panel").tabs();$("#control-panel").show()})